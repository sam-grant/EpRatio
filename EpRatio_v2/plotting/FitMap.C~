// Sam Grant - August 2019
// Draw xtal fits on a single canvas

// WIP

#include <iostream>
#include <cmath>
#include "TF1.h"
#include "TH1D.h"
#include "TCanvas.h"
#include "TFile.h"
#include "TStyle.h"
#include "TLegend.h"

using namespace std;

int main() {

  // Take command line input for dataset used
  string dataset;
  cout << "Enter run-1 dataset: 60h 9d HK EG\n";
  cin >> dataset;
  if (dataset == "60h" || dataset == "9d" || dataset == "HK" || dataset == "EG") { 
     cout << "Starting\n" << endl;
  } else { 
    cout<<"Invalid dataset, stopping"<<endl;
  }

  string inputFname = "../plots/"+dataset+"/fitsEpTimeXtal_"+fitMode+"_"+dataset+".root";
  TFile *input = TFile::Open(inputFname.c_str());
  cout<<"Reading... "<<inputFname<<endl;

  string fitName;
  string fitMode;
  cout << "Select fit mode: '1' (SingleGaus) '2' (DoubleGaus) '3' (LanGaus)\n";
  cin >> fitName;
  if (fitName == "1") {
    fitMode = "SingleGaus";
    cout << "Using fitMode: "<< fitMode << "\nStarting\n" << endl; 
  } else if(fitName == "2") {
    fitMode = "DoubleGaus";
    cout << "Using fitMode: "<< fitMode << "\nStarting\n" << endl;
  } else if(fitName == "3") {
    fitMode = "LanGaus";
    cout << "Using fitMode: "<< fitMode << "\nStarting\n" << endl;
  } else {
    cout<<"Invalid fitmode, stopping"<<endl;
    exit(0);
  }

  int place = 0;     
  // int edgeXtals[26] = {0,1,2,3,4,5,6,7,8,9,17,18,26,27,35,36,44,45,46,47,48,49,50,51,52,53};
  
  // Count crystals
  int count = 0;
  for (int stn(12) ; stn < 19 ; stn = stn + 6 ) {
    for(int xtal(0); xtal<54; xtal++) {

      string name = "S"+to_string(stn)+"/EoverPvsTimeXtal_"+to_string(xtal);
      // Change input if need be
      TH1D *h = (TH1D*)input->Get(name.c_str());
      if(h!=0) count++;
    }
  }

  // Need same number of rows as columns
  int cols = -1; 
  if(dataset == "60h") cols = 3;
  else if(dataset == "9d") cols = 4;
  int rows = count / cols;
  cout<<round(count/2)<<endl;

  TCanvas *c1  = new TCanvas("c1","c1",600,600);    
  c1->Divide(cols,rows+1);

  for (int stn(12) ; stn < 19 ; stn = stn + 6 ) {

    for(int xtal(0); xtal<54; xtal++) {

      string name = "S"+to_string(stn)+"/EoverPvsTimeXtal_"+to_string(xtal);
      // Change input if need be
      TH1D *h = (TH1D*)input->Get(name.c_str());
      if(h==0) continue;
      // Some formatting
      h->SetTitle(("Station "+to_string(stn)+", Crystal "+to_string(xtal)+";In-fill time [#mus];E/p").c_str());
      h->GetYaxis()->SetTitleOffset(1.25);
      h->GetXaxis()->SetRange(0,23);

      c1->cd(place+1);
      place++;
      cout<<place<<endl;
      h->SetStats(0);
      h->Draw();

    }

  }
  
  string fname = "../images/"+dataset+"/fitMap_"+dataset; // +".pdf";
  c1->SaveAs((fname+".pdf").c_str());
  c1->SaveAs((fname+".C").c_str());
  
  delete c1;
  return 0;
}
